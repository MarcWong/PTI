%%%initializationpath = '/Users/marcWong/Data/PerfusionSource/001A/PERFUSION/';outputPath = '/Users/marcWong/Data/ProcessedData/001A/average/';listing = dir([path '*.dcm']);fileSum = length(listing); info = dicominfo(strcat(path,listing(1).name));width = info.Width;height = info.Height;layer = 20;m = zeros([layer 1]);pic = double(zeros([layer width height]));savedPic = double(zeros([width height]));%%for imgNum=1:fileSum/8    %read dicom info header    info = dicominfo(strcat(path,listing(imgNum).name));    %read the input img and convert in into double    imgin = double(dicomread(info));        %figure;    %imshow(imgin,'DisplayRange',[]);    %max(max(imgin))    %min(min(imgin))    %tag calibration by its z coordinate    switch info.ImagePositionPatient(3)        case -33.671030050502            tag=1;        case -27.69087219833            tag=2;        case -21.710713392482            tag=3;        case -15.730555063472            tag=4;        case -9.7503967344624            tag=5;        case -3.7702379286152            tag=6;        case 2.2099199235577            tag=7;        case 8.1900787294048            tag=8;        case 14.170236581578            tag=9;        case 20.150396341099            tag=10;        case 26.130556100621            tag=11;        case 32.110712045445            tag=12;        case 38.090871804966            tag=13;        case 44.071031564488            tag=14;        case 50.051187509312            tag=15;        case 56.031343454136            tag=16;        case 62.011507028355            tag=17;        case 67.991662973179            tag=18;        case 73.971818918003            tag=19;        case 79.951982492222            tag=20;        otherwise            display(info.ImagePositionPatient(3));    end    m(tag) = m(tag) + 1;    for i = 1:width         for j = 1:height             pic(tag,i,j)=pic(tag,i,j) + imgin(i,j);         end    end    %if(mod(imgNum,40)==0)    %    display(strcat(num2str(imgNum),' processed'));    %endend%%%average for each pixelfor tag = 1:layer        for i = 1:width                for j = 1:height                    pic(tag,i,j) = pic(tag,i,j)./m(tag);                end        end        %figure;        %imshow(savedPic,'DisplayRange',[]);enddisplay('average calculation finished');%normalization%maxValue = max(pic(:));%minValue = min(pic(:));%pic = (pic - minValue) ./ (maxValue-minValue);%pic = uint8(pic .* 255.);%display('normalization finished');%write the average filefor tag = 1:layer        %write the output img        %writeDcm(imgout,i);        %savedPic = uint8(savedPic ./ max(savedPic(:)));        for i = 1:width                for j = 1:height                    savedPic(i,j) = pic(tag,i,j);                end        end        filename = strcat(num2str(tag),'.txt');        dlmwrite(strcat(outputPath,filename), savedPic, 'delimiter', ' ');        %imwrite(savedPic,strcat(outputPath,filename));        %imwrite(savedPic,strcat(outputPath,filename));        display(strcat(num2str(tag),' s0 writed'));end